[
    {
        "name": "No Resources Available",
        "description": "Catastrophic Event! Indicates potential problems with dependencies, diagnose and resolve.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 1,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT15M",
            "evaluationFrequency": "PT15M",
            "threshold": 1,
            "resouceIdColumn": "_ResourceId",
            "dimensions": [
                {
                    "name": "UserName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "SessionHostName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "WVDConnections\n| where TimeGenerated > ago (15m)\n| project-away TenantId,SourceSystem\n| summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== \\'Started\\', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== \\'Connected\\', TimeGenerated , datetime(null) )) by CorrelationId\n| join kind=leftouter (WVDErrors\n|summarize Errors=makelist(pack(\\'Code\\', Code, \\'CodeSymbolic\\', CodeSymbolic, \\'Time\\', TimeGenerated, \\'Message\\', Message ,\\'ServiceError\\', ServiceError, \\'Source\\', Source)) by CorrelationId\n) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n| summarize Checkpoints=makelist(pack(\\'Time\\', TimeGenerated, \\'Name\\', Name, \\'Parameters\\', Parameters, \\'Source\\', Source)) by CorrelationId\n| mv-apply Checkpoints on (\norder by todatetime(Checkpoints[\\'Time\\']) asc\n| summarize Checkpoints=makelist(Checkpoints))\n) on CorrelationId\n| project-away CorrelationId1, CorrelationId2\n| order by TimeGenerated desc\n| where Errors[0].CodeSymbolic == \"ConnectionFailedNoHealthyRdshAvailable\"",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "User Disconnected over 24h",
        "description": "Verify Remote Desktop Policies are applied relating to Session Limits. This could impact your scaling plan as well.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT1H",
            "evaluationFrequency": "PT1H",
            "threshold": 1,
            "resouceIdColumn": "_ResourceId",
            "dimensions": [
                {
                    "name": "UserName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "SessionHostName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "WVDConnections\n| where TimeGenerated > ago(24h)\n| where State == \"Connected\"\n| project CorrelationId , UserName, ConnectionType, StartTime=TimeGenerated, SessionHostName\n| join (WVDConnections\n| where State == \"Completed\"\n| project EndTime=TimeGenerated, CorrelationId)\non CorrelationId\n| project Duration = EndTime - StartTime, ConnectionType, UserName, SessionHostName\n| where Duration >= timespan(24:00:00)\n| sort by Duration desc",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "User Disconnected over 72h",
        "description": "Verify Remote Desktop Policies are applied relating to Session Limits. This could impact your scaling plan as well.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT1H",
            "evaluationFrequency": "PT1H",
            "threshold": 1,
            "resouceIdColumn": "_ResourceId",
            "dimensions": [
                {
                    "name": "UserName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "SessionHostName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "WVDConnections | where TimeGenerated > ago(24h) | where State == \"Connected\" | project CorrelationId , UserName, ConnectionType, StartTime=TimeGenerated, SessionHostName | join (WVDConnections\n  | where State == \"Completed\"\n  | project EndTime=TimeGenerated, CorrelationId)\non CorrelationId | project Duration = EndTime - StartTime, ConnectionType, UserName, SessionHostName | where Duration >= timespan(72:00:00) | sort by Duration desc",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Profile less than 5%",
        "description": "User Profiles Service logged Event ID 33. Expand User's Virtual Profile Disk and/or clean up user profile data on the VM.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT5M",
            "evaluationFrequency": "PT5M",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Warning\"\n| where EventID == 34\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Profile less than 2%",
        "description": "User Profiles Service logged Event ID 34. Expand User's Virtual Profile Disk and/or clean up user profile data on the VM.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 1,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT5M",
            "evaluationFrequency": "PT5M",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Error\"\n| where EventID == 33\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Network Issue",
        "description": "User Profiles Service logged Event ID 43. Verify network communications between the storage and AVD VM.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 1,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT24H",
            "evaluationFrequency": "PT5M",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Error\"\n| where EventID == 43\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Profile Disk Failed to Attach",
        "description": "User Profiles Service logged an Event ID 52 or 40. Investigate error details for reason.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 1,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT24H",
            "evaluationFrequency": "PT5M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Error\"\n| where EventID == 42 or EventID == 40\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Service Disabled",
        "description": "User Profile Service Disabled. Determine why service was disabled and re-enable / start the FSLogix service.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 1,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT24H",
            "evaluationFrequency": "PT5M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Warning\"\n| where EventID == 60\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Disk Compact Failure",
        "description": "User Profile Service logged Event ID 62 or 63. The profile Disk was marked for compaction due to additional white space but failed. See error details for additional information.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT24H",
            "evaluationFrequency": "PT5M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Error\"\n| where EventID == 62 or EventID == 63\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "FSLogix Disk Already In Use",
        "description": "User Profile Service logged an Event ID 51. This indicates that a user attempted to load their profile disk but it was in use or possibly mapped to another VM. Ensure the user is not connected to another host pool or remote app with the same profile.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT24H",
            "evaluationFrequency": "PT5M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "ComputerName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "RenderedDescription",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "VMresourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Operational\"\n| where EventLevelName == \"Warning\"\n| where EventID == 51\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" ResourceGroup \"/providers/microsoft.compute/virtualmachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated\n| join kind = leftouter\n(WVDAgentHealthStatus\n| parse _ResourceId with \"/subscriptions/\" subscriptionAgentHealth \"/resourcegroups/\" ResourceGroupAgentHealth \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" VMsubscription \"/resourceGroups/\" VMresourceGroup \"/providers/Microsoft.Compute/virtualMachines/\" ComputerName\n| extend ComputerName=tolower(ComputerName)\n| summarize arg_max(TimeGenerated,*) by ComputerName\n| project VMresourceGroup, ComputerName, HostPool\n) on ComputerName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "Session Host Healthcheck Failure",
        "description": "VM is available for use but one of the dependent resources is in a failed state.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 2,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT15M",
            "evaluationFrequency": "PT15M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "SessionHostName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HealthCheckDesc",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "SessionHostRG",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "let MapToDesc = (idx: long) {\ncase(idx == 0, \"DomainJoin\",\nidx == 1, \"DomainTrust\",\nidx == 2, \"FSLogix\",\nidx == 3, \"SxSStack\",\nidx == 4, \"URLCheck\",\nidx == 5, \"GenevaAgent\",\nidx == 6, \"DomainReachable\",\nidx == 7, \"WebRTCRedirector\",\nidx == 8, \"SxSStackEncryption\",\nidx == 9, \"IMDSReachable\",\nidx == 10, \"MSIXPackageStaging\",\n\"InvalidIndex\")};\nWVDAgentHealthStatus\n| where TimeGenerated > ago(10m)\n| where Status != \\'Available\\'\n| where AllowNewSessions = True\n| extend CheckFailed = parse_json(SessionHostHealthCheckResult)\n| mv-expand CheckFailed\n| where CheckFailed.AdditionalFailureDetails.ErrorCode != 0\n| extend HealthCheckName = tolong(CheckFailed.HealthCheckName)\n| extend HealthCheckResult = tolong(CheckFailed.HealthCheckResult)\n| extend HealthCheckDesc = MapToDesc(HealthCheckName)\n| where HealthCheckDesc != \\'InvalidIndex\\'\n| parse _ResourceId with \"/subscriptions/\" subscription \"/resourcegroups/\" HostPoolResourceGroup \"/providers/microsoft.desktopvirtualization/hostpools/\" HostPool\n| parse SessionHostResourceId with \"/subscriptions/\" HostSubscription \"/resourceGroups/\" SessionHostRG \" /providers/Microsoft.Compute/virtualMachines/\" SessionHostName",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    },
    {
        "name": "User Connection to Session Host Failure",
        "description": "A user failed to connect to a VM. There are lots of variables between the end uers and AVD VMs. If this is frequent for the user, determine if their Internet connection is slow or latency is over 150 ms.",
        "type": "Log",
        "verified": true,
        "visible": true,
        "tags": [
            "avd"
        ],
        "properties": {
            "severity": 3,
            "operator": "GreaterThanOrEqual",
            "timeAggregation": "Count",
            "windowSize": "PT5M",
            "evaluationFrequency": "PT5M",
            "resourceIdColumn": "_ResourceId",
            "threshold": 1,
            "dimensions": [
                {
                    "name": "HostPool",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ResourceGroup",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "UserName",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ClientOS",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ClientVersion",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ClientSideIPAddress",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ConnectionType",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ErrorShort",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                },
                {
                    "name": "ErrorMessage",
                    "operator": "Include",
                    "values": [
                        "*"
                    ]
                }
            ],
            "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
            },
            "query": "WVDConnections\n//  | where UserName == \"upn.here@contoso.com\"\n| project-away TenantId,SourceSystem\n| summarize arg_max(TimeGenerated, *), StartTime = min(iff(State=='Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State=='Connected', TimeGenerated , datetime(null) )) by CorrelationId\n| join kind=leftouter (WVDErrors\n|summarize Errors=make_list(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId\n) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n| summarize Checkpoints=make_list(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId\n| mv-apply Checkpoints on (\norder by todatetime(Checkpoints['Time']) asc\n| summarize Checkpoints=make_list(Checkpoints))\n) on CorrelationId\n| project-away CorrelationId1, CorrelationId2\n| order by TimeGenerated desc\n| where TimeGenerated > ago(15m)\n| extend ResourceGroup=tostring(split(_ResourceId, '/')[4])\n| extend HostPool=tostring(split(_ResourceId, '/')[8])\n| extend ErrorShort=tostring(Errors[0].CodeSymbolic)\n| extend ErrorMessage=tostring(Errors[0].Message)\n| project TimeGenerated, HostPool, ResourceGroup, UserName, ClientOS, ClientVersion, ClientSideIPAddress, ConnectionType, ErrorShort, ErrorMessage",
            "autoMitigate": true,
            "autoResolve": true,
            "autoResolveTime": "0:30:00"
        },
        "references": "",
        "deployments": [
            {
                "name": "AVD-HostPool",
                "template": "Deploy-AVD-HostPool-Alert.json",
                "type": "Policy",
                "tags": [
                    "alz"
                ],
                "properties": {
                    "scope": "Subscription",
                    "multiResource": false
                }
            }
        ]
    }
]