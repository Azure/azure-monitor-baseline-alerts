{
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "name": "Deploy_AlertProcessing_Rule",
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy Alert Processing Rule",
    "description": "Policy to Deploy Deploy Alert Processing Rule with Action Group",
    "metadata": {
      "version": "1.0.1",
      "category": "Monitoring",
      "source": "https://github.com/Azure/azure-monitor-baseline-alerts/",
      "ALZCloudEnvironments": [
        "AzureCloud"
      ],
      "_deployed_by_amba": "True"
    },
    "parameters": {
      "AMBAMonitorResourceGroupName": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Group Name",
          "description": "Resource group the alert is placed in"
        },
        "defaultValue": "AMBAMonitoring-rg"
      },
      "AMBAMonitorResourceGroupTags": {
        "type": "Object",
        "metadata": {
          "displayName": "Resource Group Tags",
          "description": "Tags on the Resource group the alert is placed in"
        },
        "defaultValue": {
            "_deployed_by_alz": true
        }
      },
      "AMBAMonitorResourceGroupLocation": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Group Location",
          "description": "Location of the Resource group the alert is placed in"
        },
        "defaultValue": "centralus"
      },
      "AMBAMonitorActionGroupEmail": {
        "type": "String",
        "metadata": {
          "displayName": "Action Group Email",
          "description": "Email address to send alerts to"
        },
        "defaultValue": "action@mail.com"
      },
      "AMBAAGLogicappResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Logic App Resource Id",
          "description": "Logic App Resource Id for Action Group to send alerts to"
        },
        "defaultValue": ""
      },
      "AMBAAGLogicAppcallbackUrl": {
        "type": "String",
        "metadata": {
          "displayName": "Logic App Callback Url",
          "description": "Logic App Callback Url for Action Group"
        },
        "defaultValue": ""
      },
      "AMBAEventHubResourceId":{
        "type": "String",
        "metadata": {
          "displayName": "Event Hub Resource Id",
          "description": "Event Hub Resource Id for action group to send alerts to "
        },
        "defaultValue": ""
      },
 
      "AMBAAGEHTenantId": {
        "type": "String",
        "metadata": {
          "displayName": "Event Hub Tenant Id",
          "description": "Event Hub Tenant Id"
        },
        "defaultValue": ""
      },
      
   
      "AMBAAGAADObjectId": {
        "type": "String",
        "metadata": {
          "displayName": "Entra Object Id Secure Webhook ",
          "description": "Indicates the Entra object id for Entra auth in a secure webhook"
        },
        "defaultValue": ""
      },
     "AMBAAGWHTenantId": {
        "type": "String",
        "metadata": {
          "displayName": "Tenant Id Secure Webhook ",
          "description": "Indicates the tenant id in a secure webhook"
        },
        "defaultValue": ""
      },
      "AMBAAGServiceUri": {
        "type": "String",
        "metadata": {
          "displayName": "Service Uri Webhook ",
          "description": "Indicates the webhook service uri in a webhook"
        },
        "defaultValue": ""
      },
      "AMBAAGuseAadAuth": {
        "type": "String",
        "metadata": {
          "displayName": "Use Entra Auth",
          "description": "Indicates if the webhook should be secure and use Entra Authorisation set to true or false"
        },
        "defaultValue": "false"
      },
      "AMBAAGIdentifierUri": {
        "type": "String",
        "metadata": {
          "displayName": "Identifier Uri Webhook ",
          "description": "Indicates the webhook identifier uri in a webhook"
        },
        "defaultValue": ""
      },
      "AMBAAGArmRoleId": {
        "type": "String",
        "metadata": {
          "displayName": "Arm Role Id",
          "description": "Arm Built-in Role Id for action group to send alerts to a subscription level, will only send to individual members of role"
        },
        "defaultValue": ""
      },
      "AMBAMonitorActionGroupFunctionAppResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Function App Resource Id",
          "description": "Function App Resource Id for Action Group to send alerts to"
        },
        "defaultValue": ""
      },
      "AMBAMonitorActionGroupFunctionName": {
        "type": "String",
        "metadata": {
          "displayName": "Function Name",
          "description": "Function Name for Action Group to send alerts to"
        },
        "defaultValue": ""
      },
      "AMBAMonitorActionGroupFunctionHttpTriggerUrl": {
        "type": "String",
        "metadata": {
          "displayName": "Function Http Trigger Url",
          "description": "Function Http Trigger Url for Action Group to send alerts to"
        },
        "defaultValue": ""
      },
  
      "MonitorDisable": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Tag name to disable monitoring at subscription. Set to true if monitoring process rule should be disabled"
        },
        "defaultValue": "MonitorDisable"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          },
          {
            "field": "[[concat('tags[', parameters('MonitorDisable'), ']')]",
            "notEquals": "true"
          }
        ]
      },
      "then": {
        "effect": "deployIfNotExists",
        "details": {
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "type": "Microsoft.AlertsManagement/actionRules",
          "existenceScope": "resourcegroup",
          "resourceGroupName": "[[parameters('AMBAMonitorResourceGroupName')]",
          "deploymentScope": "subscription",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.AlertsManagement/actionRules/description",
                "equals": "AMBA Alert Processing Rule for Subscription"
              }
            ]
          },
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "AMBAMonitorResourceGroupName": {
                    "type": "string"
                  },
                  "AMBAMonitorResourceGroupTags": {
                    "type": "object"
                  },
                  "AMBAMonitorResourceGroupLocation": {
                    "type": "string"
                  },
                  "AMBAMonitorActionGroupEmail": {
                    "type": "string"
                  },
                  "AMBAAGLogicAppcallbackUrl": {
                    "type": "string"
                  },
                  "AMBAAGLogicappResourceId": {
                    "type": "string"
                  },
                  "AMBAEventHubResourceId": {
                    "type": "string"
                  },          
            
                  "AMBAAGEHTenantId": {
                    "type": "string"
                  },
                  "AMBAAGAADObjectId": {
                    "type": "string"
                  },
                  "AMBAAGIdentifierUri": {
                    "type": "string"
                  },                
                  "AMBAAGServiceUri": {
                    "type": "string"
                  },
                  "AMBAAGWHTenantId": {
                    "type": "string"
                  },
                  "AMBAAGuseAadAuth":{
                    "type": "string"
                  },
                  "AMBAAGArmRoleId":{
                    "type": "string"
                  },
                  "AMBAMonitorActionGroupFunctionAppResourceId": {
                    "type": "string"
                  },
                  "AMBAMonitorActionGroupFunctionName": {
                    "type": "string"
                  },
                  "AMBAMonitorActionGroupFunctionHttpTriggerUrl": {
                    "type": "string"
                  }
                },
                "variables": {
                   "varAMBAMonitorActionGroupEmail": "[[array(split(parameters('AMBAMonitorActionGroupEmail'),','))]",
                   "varAMBAMonitorActionGroupArmRoleId":"[[array(split(parameters('AMBAAGArmRoleId'),','))]",
                   "varAMBAEventHubResourceId":"[[array(split(parameters('AMBAEventHubResourceId'),'/'))]",
                   "varActionGroupReceivers": {
                      "varlogicAppReceivers": [
                        {
                          "name": "AMBAActionLogicApp",
                          "callbackUrl":"[[parameters('AMBAAGLogicAppcallbackUrl')]",
                          "resourceId": "[[parameters('AMBAAGLogicappResourceId')]",
                          "useCommonAlertSchema": true
                        }
                      ],
                      "varEventHubReceiver": [
                        {
                          
                          "eventHubName": "[[variables('varAMBAEventHubResourceId')[10]]",
                          "eventHubNameSpace": "[[variables('varAMBAEventHubResourceId')[8]]",
                          "name": "AMBAActionEventHub",
                          "subscriptionId":  "[[variables('varAMBAEventHubResourceId')[2]]",
                          "tenantId": "[[parameters('AMBAAGEHTenantId')]",
                          "useCommonAlertSchema": true
                        }
                      ],
                      "varWebhookReceiver": [
                        {
                          "identifierUri": "[[parameters('AMBAAGIdentifierUri')]",
                          "name": "AMBAActionWebHook",
                          "objectId": "[[parameters('AMBAAGAADObjectId')]",
                          "serviceUri": "[[parameters('AMBAAGServiceUri')]",
                          "tenantId": "[[parameters('AMBAAGWHTenantId')]",
                          "useAadAuth": "[[parameters('AMBAAGuseAadAuth')]",
                          "useCommonAlertSchema": true
                        }
                      ],
                      "varFunctionReceivers": [
                        {
                          "functionAppResourceId": "[[parameters('AMBAMonitorActionGroupFunctionAppResourceId')]",
                          "functionName": "[[parameters('AMBAMonitorActionGroupFunctionName')]",
                          "httpTriggerUrl": "[[parameters('AMBAMonitorActionGroupFunctionHttpTriggerUrl')]",
                          "name": "AMBAActionFunction",
                          "useCommonAlertSchema": true
                        }
                      ]
                  
                  
                    
                    }
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/resourceGroups",
                    "apiVersion": "2021-04-01",
                    "name": "[[parameters('AMBAMonitorResourceGroupName')]",
                    "location": "[[parameters('AMBAMonitorResourceGroupLocation')]",
                    "tags": "[[parameters('AMBAMonitorResourceGroupTags')]"
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2019-10-01",
                    "name": "ActionGroupDeployment",
                    "resourceGroup": "[[parameters('AMBAMonitorResourceGroupName')]",
                    "dependsOn": [
                      "[[concat('Microsoft.Resources/resourceGroups/', parameters('AMBAMonitorResourceGroupName'))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "AMBAMonitorResourceGroupName": {
                            "type": "string"
                          },
                          "AMBAMonitorActionGroupEmail": {
                            "type": "string"
                          },
                          "AMBAAGLogicAppcallbackUrl": {
                            "type": "string"
                          },
                          "AMBAAGLogicappResourceId": {
                            "type": "string"
                          },               
                        
                          "AMBAAGAADObjectId": {
                            "type": "string"
                          },

                         "AMBAEventHubResourceId": {
                            "type": "string"
                          },

                          "AMBAAGEHTenantId": {
                            "type": "string"
                          },
                       
                          "AMBAAGIdentifierUri": {
                            "type": "string"
                          },
                          "AMBAAGServiceUri": {
                            "type": "string"
                          },
                  
                          "AMBAAGWHTenantId": {
                            "type": "string"
                          },
                          "AMBAAGuseAadAuth":{
                            "type": "string"
                          },
                          "AMBAAGArmRoleId":{
                            "type": "string"
                          },
                          "AMBAMonitorActionGroupFunctionAppResourceId": {
                            "type": "string"
                          },
                          "AMBAMonitorActionGroupFunctionName": {
                            "type": "string"
                          },
                          "AMBAMonitorActionGroupFunctionHttpTriggerUrl": {
                            "type": "string"
                          }
                          
                         
                        },
                        "variables": {},
                        "resources": [
                            {
                                "condition": "[[not(empty(parameters('AMBAAGArmRoleId')))]",
                                "type": "Microsoft.Insights/actionGroups",
                                "apiVersion": "2022-06-01",
                                "name": "AmbaActionGrp",
                                "location": "Global",
                                "tags": {
                                    "_deployed_by_amba": true
                                  },
                                "properties": {
                                    "groupShortName": "AMBAActnGrp",
                                    "enabled": true,
                                    "copy": [
                                        {
                                            "name": "emailReceivers",
                                            "count": "[[length(variables('varAMBAMonitorActionGroupEmail'))]",
                                            "mode": "serial",
                                            "input": {
                                                "name": "[[concat('AMBAMail-', indexOf(variables('varAMBAMonitorActionGroupEmail'), variables('varAMBAMonitorActionGroupEmail')[copyIndex('emailReceivers')]))]",
                                                "emailAddress": "[[trim(variables('varAMBAMonitorActionGroupEmail')[copyIndex('emailReceivers')])]",
                                                "useCommonSchema": true
                                            }
                                        },


                                        {
                                          "name": "armRoleReceivers",
                                          "count": "[[length(variables('varAMBAMonitorActionGroupArmRoleId'))]",
                                            "mode": "serial",
                                            "input": {
                                                "name": "[[concat('AMBAARM-', indexOf(variables('varAMBAMonitorActionGroupArmRoleId'), variables('varAMBAMonitorActionGroupArmRoleId')[copyIndex('armRoleReceivers')]))]",
                                                "roleId": "[[trim(variables('varAMBAMonitorActionGroupArmRoleId')[copyIndex('armRoleReceivers')])]",
                                                "useCommonSchema": true
                                            }




                                        }
                                    ],
                                 
                                    
                                    "logicAppReceivers": "[[if(empty(parameters('AMBAAGLogicappResourceId')),null(),variables('varActionGroupReceivers').varlogicAppReceivers)]",
                                    "eventHubReceivers": "[[if(empty(parameters('AMBAEventHubResourceId')),null(),variables('varActionGroupReceivers').varEventHubReceiver)]",
                                    "webhookReceivers": "[[if(empty(parameters('AMBAAGServiceUri')),null(),variables('varActionGroupReceivers').varWebhookReceiver)]",
                                    "azureFunctionReceivers": "[[if(empty(parameters('AMBAMonitorActionGroupFunctionAppResourceId')),null(),variables('varActionGroupReceivers').varFunctionReceivers)]"
                                    
                                    

                                }
                            },
                            {
                              "condition":"[[empty(parameters('AMBAAGArmRoleId'))]",
                              "type": "Microsoft.Insights/actionGroups",
                              "apiVersion": "2022-06-01",
                              "name": "AmbaActionGrp",
                              "location": "Global",
                              "tags": {
                                  "_deployed_by_amba": true
                                },
                              "properties": {
                                  "groupShortName": "AMBAActnGrp",
                                  "enabled": true,
                                  "copy": [
                                      {
                                          "name": "emailReceivers",
                                          "count": "[[length(variables('varAMBAMonitorActionGroupEmail'))]",
                                          "mode": "serial",
                                          "input": {
                                              "name": "[[concat('AMBAMail-', indexOf(variables('varAMBAMonitorActionGroupEmail'), variables('varAMBAMonitorActionGroupEmail')[copyIndex('emailReceivers')]))]",
                                              "emailAddress": "[[trim(variables('varAMBAMonitorActionGroupEmail')[copyIndex('emailReceivers')])]",
                                              "useCommonSchema": true
                                          }
                                      }                                 
                                     
                                      
                                  ],
                               
                                  
                                  "logicAppReceivers": "[[if(empty(parameters('AMBAAGLogicappResourceId')),null(),variables('varActionGroupReceivers').varlogicAppReceivers)]",
                                  "eventHubReceivers": "[[if(empty(parameters('AMBAEventHubResourceId')),null(),variables('varActionGroupReceivers').varEventHubReceiver)]",
                                  "webhookReceivers": "[[if(empty(parameters('AMBAAGServiceUri')),null(),variables('varActionGroupReceivers').varWebhookReceiver)]",
                                  "azureFunctionReceivers": "[[if(empty(parameters('AMBAMonitorActionGroupFunctionAppResourceId')),null(),variables('varActionGroupReceivers').varFunctionReceivers)]"
                                
                                  
                                  

                              }
                          },
                            {
                                "type": "Microsoft.AlertsManagement/actionRules",
                                "apiVersion": "2021-08-08",
                                "name": "AMBA Alert Processing Rule",
                                "location": "Global",
                                "dependsOn": [
                                    "[[concat('Microsoft.Insights/actionGroups/', 'AMBAActionGrp')]"
                                ],
                                "tags": {
                                    "_deployed_by_amba": true
                                },
                                "properties": {
                                    "scopes": [
                                        "[[subscription().Id]"
                                    ],
                                    "description": "AMBA Alert Processing Rule for Subscription",
                                    "enabled": true,
                                    "actions": [
                                        {
                                        "actiongroupIds": [
                                            "[[[concat(subscription().Id, '/resourceGroups/', parameters('AMBAMonitorResourceGroupName'), '/providers/Microsoft.Insights/actionGroups/AMBAActionGrp')]"
                                        ],
                                        "actionType": "AddActionGroups"
                                        }
                                    ]
                                }
                            }
                        ]
                      },
                      "parameters": {
                        "AMBAMonitorResourceGroupName": {
                          "value": "[[parameters('AMBAMonitorResourceGroupName')]"
                        },
                        "AMBAMonitorActionGroupEmail": {
                          "value": "[[parameters('AMBAMonitorActionGroupEmail')]"
                        },
                        "AMBAAGLogicAppcallbackUrl": {
                          "value": "[[parameters('AMBAAGLogicAppcallbackUrl')]"
                        },
                        "AMBAAGLogicappResourceId": {
                          "value": "[[parameters('AMBAAGLogicappResourceId')]"
                        },
             
                     "AMBAEventHubResourceId": {
                          "value": "[[parameters('AMBAEventHubResourceId')]"
                        },
                        "AMBAAGAADObjectId": {
                          "value": "[[parameters('AMBAAGAADObjectId')]"
                        },
                   
                        "AMBAAGEHTenantId": {
                          "value": "[[parameters('AMBAAGEHTenantId')]"
                        },

                        "AMBAAGIdentifierUri": {
                          "value": "[[parameters('AMBAAGIdentifierUri')]"
                        },
                        "AMBAAGServiceUri": {
                          "value": "[[parameters('AMBAAGServiceUri')]"
                        },                  
                        "AMBAAGWHTenantId": {
                          "value": "[[parameters('AMBAAGWHTenantId')]"
                        },
                        "AMBAAGuseAadAuth":{
                          "value": "[[parameters('AMBAAGuseAadAuth')]"
                        },
                        "AMBAAGArmRoleId":{
                          "value": "[[parameters('AMBAAGArmRoleId')]"
                        },
                        "AMBAMonitorActionGroupFunctionAppResourceId": {
                          "value": "[[parameters('AMBAMonitorActionGroupFunctionAppResourceId')]"
                        },
                        "AMBAMonitorActionGroupFunctionName": {
                          "value": "[[parameters('AMBAMonitorActionGroupFunctionName')]"
                        },
                        "AMBAMonitorActionGroupFunctionHttpTriggerUrl": {
                          "value": "[[parameters('AMBAMonitorActionGroupFunctionHttpTriggerUrl')]"
                        }
                      
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "AMBAMonitorResourceGroupName": {
                  "value": "[[parameters('AMBAMonitorResourceGroupName')]"
                },
                "AMBAMonitorResourceGroupTags": {
                  "value": "[[parameters('AMBAMonitorResourceGroupTags')]"
                },
                "AMBAMonitorResourceGroupLocation": {
                  "value": "[[parameters('AMBAMonitorResourceGroupLocation')]"
                },
                "AMBAMonitorActionGroupEmail": {
                  "value": "[[parameters('AMBAMonitorActionGroupEmail')]"
                },
                "AMBAAGLogicAppcallbackUrl": {
                  "value": "[[parameters('AMBAAGLogicAppcallbackUrl')]"
                },
                "AMBAAGLogicappResourceId": {
                  "value": "[[parameters('AMBAAGLogicappResourceId')]"
                },
             
                "AMBAAGAADObjectId": {
                  "value": "[[parameters('AMBAAGAADObjectId')]"
                },
                "AMBAEventHubResourceId": {
                  "value": "[[parameters('AMBAEventHubResourceId')]"
                },
    
                "AMBAAGEHTenantId": {
                  "value": "[[parameters('AMBAAGEHTenantId')]"
                },
           
                "AMBAAGIdentifierUri": {
                  "value": "[[parameters('AMBAAGIdentifierUri')]"
                },
                "AMBAAGServiceUri": {
                  "value": "[[parameters('AMBAAGServiceUri')]"
                },
           
                "AMBAAGWHTenantId": {
                  "value": "[[parameters('AMBAAGWHTenantId')]"
                },
                "AMBAAGuseAadAuth":{
                  "value": "[[parameters('AMBAAGuseAadAuth')]"
                },
                "AMBAAGArmRoleId":{
                  "value": "[[parameters('AMBAAGArmRoleId')]"
                },
                "AMBAMonitorActionGroupFunctionAppResourceId": {
                  "value": "[[parameters('AMBAMonitorActionGroupFunctionAppResourceId')]"
                },
                "AMBAMonitorActionGroupFunctionName": {
                  "value": "[[parameters('AMBAMonitorActionGroupFunctionName')]"
                },
                "AMBAMonitorActionGroupFunctionHttpTriggerUrl": {
                  "value": "[[parameters('AMBAMonitorActionGroupFunctionHttpTriggerUrl')]"
                }
    
                
              }
            }
          }
        }
      }
    }
  }
}
