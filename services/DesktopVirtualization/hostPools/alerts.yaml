- name: No Resources Available
  description: Catastrophic Event! Indicates potential problems with dependencies, diagnose and resolve.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 1
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT15M
    evaluationFrequency: PT15M
    threshold: 1
    resouceIdColumn: _ResourceId
    dimensions:
      - name: UserName
        operator: Include
        values:
          - "*"
      - name: SessionHostName
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      WVDConnections
      | where TimeGenerated > ago (15m)
      | project-away TenantId,SourceSystem
      | summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== 'Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== 'Connected', TimeGenerated , datetime(null) )) by CorrelationId
      | join kind=leftouter (WVDErrors
      |summarize Errors=makelist(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId
      ) on CorrelationId
      | join kind=leftouter (WVDCheckpoints
      | summarize Checkpoints=makelist(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId
      | mv-apply Checkpoints on (
      order by todatetime(Checkpoints['Time']) asc
      | summarize Checkpoints=makelist(Checkpoints))
      ) on CorrelationId
      | project-away CorrelationId1, CorrelationId2
      | order by TimeGenerated desc
      | where Errors[0].CodeSymbolic == "ConnectionFailedNoHealthyRdshAvailable"
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: User Disconnected over 24h
  description: Verify Remote Desktop Policies are applied relating to Session Limits. This could impact your scaling plan as well.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT1H
    evaluationFrequency: PT1H
    threshold: 1
    resouceIdColumn: _ResourceId
    dimensions:
      - name: UserName
        operator: Include
        values:
          - "*"
      - name: SessionHostName
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      WVDConnections
      | where TimeGenerated > ago(24h)
      | where State == "Connected"
      | project CorrelationId , UserName, ConnectionType, StartTime=TimeGenerated, SessionHostName
      | join (WVDConnections
      | where State == "Completed"
      | project EndTime=TimeGenerated, CorrelationId)
      on CorrelationId
      | project Duration = EndTime - StartTime, ConnectionType, UserName, SessionHostName
      | where Duration >= timespan(24:00:00)
      | sort by Duration desc
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: User Disconnected over 72h
  description: Verify Remote Desktop Policies are applied relating to Session Limits. This could impact your scaling plan as well.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT1H
    evaluationFrequency: PT1H
    threshold: 1
    resouceIdColumn: _ResourceId
    dimensions:
      - name: UserName
        operator: Include
        values:
          - "*"
      - name: SessionHostName
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      WVDConnections
      | where TimeGenerated > ago(24h)
      | where State == "Connected"
      | project CorrelationId , UserName, ConnectionType, StartTime=TimeGenerated, SessionHostName
      | join (WVDConnections
        | where State == "Completed"
        | project EndTime=TimeGenerated, CorrelationId)
      on CorrelationId
      | project Duration = EndTime - StartTime, ConnectionType, UserName, SessionHostName
      | where Duration >= timespan(72:00:00)
      | sort by Duration desc
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Profile less than 5 Percent
  description: User Profiles Service logged Event ID 33. Expand User's Virtual Profile Disk and/or clean up user profile data on the VM.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT5M
    evaluationFrequency: PT5M
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Warning"
      | where EventID == 34
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Profile less than 2 Percent
  description: User Profiles Service logged Event ID 34. Expand User's Virtual Profile Disk and/or clean up user profile data on the VM.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 1
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT5M
    evaluationFrequency: PT5M
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Error"
      | where EventID == 33
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Network Issue
  description: User Profiles Service logged Event ID 43. Verify network communications between the storage and AVD VM.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 1
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT24H
    evaluationFrequency: PT5M
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Error"
      | where EventID == 43
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Profile Disk Failed to Attach
  description: User Profiles Service logged an Event ID 52 or 40. Investigate error details for reason.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 1
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT24H
    evaluationFrequency: PT5M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Error"
      | where EventID == 42 or EventID == 40
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Service Disabled
  description: User Profile Service Disabled. Determine why service was disabled and re-enable / start the FSLogix service.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 1
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT24H
    evaluationFrequency: PT5M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Warning"
      | where EventID == 60
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Disk Compact Failure
  description: User Profile Service logged Event ID 62 or 63. The profile Disk was marked for compaction due to additional white space but failed. See error details for additional information.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT24H
    evaluationFrequency: PT5M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Admin"
      | where EventLevelName == "Error"
      | where EventID == 62 or EventID == 63
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: FSLogix Disk Already In Use
  description: User Profile Service logged an Event ID 51. This indicates that a user attempted to load their profile disk but it was in use or possibly mapped to another VM. Ensure the user is not connected to another host pool or remote app with the same profile.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT24H
    evaluationFrequency: PT5M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: ComputerName
        operator: Include
        values:
          - "*"
      - name: RenderedDescription
        operator: Include
        values:
          - "*"
      - name: VMresourceGroup
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: _ResourceId
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      Event
      | where EventLog == "Microsoft-FSLogix-Apps/Operational"
      | where EventLevelName == "Warning"
      | where EventID == 51
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" ResourceGroup "/providers/microsoft.compute/virtualmachines/" ComputerName
      | extend ComputerName=tolower(ComputerName)
      | project ComputerName, RenderedDescription, subscription, ResourceGroup, TimeGenerated
      | join kind = leftouter
      (WVDAgentHealthStatus
        | parse _ResourceId with "/subscriptions/" subscriptionAgentHealth "/resourcegroups/" ResourceGroupAgentHealth "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
        | parse SessionHostResourceId with "/subscriptions/" VMsubscription "/resourceGroups/" VMresourceGroup "/providers/Microsoft.Compute/virtualMachines/" ComputerName
        | extend ComputerName=tolower(ComputerName)
        | summarize arg_max(TimeGenerated,*) by ComputerName
        | project VMresourceGroup, ComputerName, HostPool, _ResourceId
      ) on ComputerName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: Session Host Healthcheck Failure
  description: VM is available for use but one of the dependent resources is in a failed state.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 2
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT15M
    evaluationFrequency: PT15M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: SessionHostName
        operator: Include
        values:
          - "*"
      - name: HealthCheckDesc
        operator: Include
        values:
          - "*"
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: SessionHostRG
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      let MapToDesc = (idx: long) {
      case(idx == 0, "DomainJoin",
      idx == 1, "DomainTrust",
      idx == 2, "FSLogix",
      idx == 3, "SxSStack",
      idx == 4, "URLCheck",
      idx == 5, "GenevaAgent",
      idx == 6, "DomainReachable",
      idx == 7, "WebRTCRedirector",
      idx == 8, "SxSStackEncryption",
      idx == 9, "IMDSReachable",
      idx == 10, "MSIXPackageStaging",
      "InvalidIndex")};
      WVDAgentHealthStatus
      | where TimeGenerated > ago(10m)
      | where Status != 'Available'
      | where AllowNewSessions = True
      | extend CheckFailed = parse_json(SessionHostHealthCheckResult)
      | mv-expand CheckFailed
      | where CheckFailed.AdditionalFailureDetails.ErrorCode != 0
      | extend HealthCheckName = tolong(CheckFailed.HealthCheckName)
      | extend HealthCheckResult = tolong(CheckFailed.HealthCheckResult)
      | extend HealthCheckDesc = MapToDesc(HealthCheckName)
      | where HealthCheckDesc != 'InvalidIndex'
      | parse _ResourceId with "/subscriptions/" subscription "/resourcegroups/" HostPoolResourceGroup "/providers/microsoft.desktopvirtualization/hostpools/" HostPool
      | parse SessionHostResourceId with "/subscriptions/" HostSubscription "/resourceGroups/" SessionHostRG " /providers/Microsoft.Compute/virtualMachines/" SessionHostName
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
- name: User Connection to Session Host Failure
  description: A user failed to connect to a VM. There are lots of variables between the end uers and AVD VMs. If this is frequent for the user, determine if their Internet connection is slow or latency is over 150 ms.
  type: Log
  verified: true
  visible: true
  tags:
    - avd
  properties:
    severity: 3
    operator: GreaterThanOrEqual
    timeAggregation: Count
    windowSize: PT5M
    evaluationFrequency: PT5M
    resourceIdColumn: _ResourceId
    threshold: 1
    dimensions:
      - name: HostPool
        operator: Include
        values:
          - "*"
      - name: ResourceGroup
        operator: Include
        values:
          - "*"
      - name: UserName
        operator: Include
        values:
          - "*"
      - name: ClientOS
        operator: Include
        values:
          - "*"
      - name: ClientVersion
        operator: Include
        values:
          - "*"
      - name: ClientSideIPAddress
        operator: Include
        values:
          - "*"
      - name: ConnectionType
        operator: Include
        values:
          - "*"
      - name: ErrorShort
        operator: Include
        values:
          - "*"
      - name: ErrorMessage
        operator: Include
        values:
          - "*"
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: >-
      WVDConnections
      //  | where UserName == "upn.here@contoso.com"
      | project-away TenantId,SourceSystem
      | summarize arg_max(TimeGenerated, *), StartTime = min(iff(State=='Started', TimeGenerated , datetime(null))), ConnectTime = min(iff(State=='Connected', TimeGenerated , datetime(null))) by CorrelationId
      | join kind=leftouter (WVDErrors
      |summarize Errors=make_list(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId
      ) on CorrelationId
        | join kind=leftouter (WVDCheckpoints
        | summarize Checkpoints=make_list(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId
        | mv-apply Checkpoints on (
        order by todatetime(Checkpoints['Time']) asc
        | summarize Checkpoints=make_list(Checkpoints))
      ) on CorrelationId
      | project-away CorrelationId1, CorrelationId2
      | order by TimeGenerated desc
      | where TimeGenerated > ago(15m)
      | extend ResourceGroup=tostring(split(_ResourceId, '/')[4])
      | extend HostPool=tostring(split(_ResourceId, '/')[8])
      | extend ErrorShort=tostring(Errors[0].CodeSymbolic)
      | extend ErrorMessage=tostring(Errors[0].Message)
      | project ResourceGroup, UserName, ClientOS, ClientVersion, ClientSideIPAddress, ConnectionType, ErrorShort, ErrorMessage, HostPool
    autoMitigate: true
    autoResolve: true
    autoResolveTime: "0:30:00"
  references:
  deployments:
    - name: AVD-HostPool
      template: Deploy-AVD-HostPool-Alert.json
      type: Policy
      tags:
        - alz
      properties:
        scope: Subscription
        multiResource: false
